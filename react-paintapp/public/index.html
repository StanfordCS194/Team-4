<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <!--
      manifest.json provides metadata used when your web app is added to the
      homescreen on Android. See https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json">
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700" rel="stylesheet">
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>React App</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
        }

        #stage-parent {
            width: 100%;
        }
    </style>

  </head>
  <body>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>
    <div id="root"></div>
    <div id="stage-parent">
        <div id="container"></div>
    </div>


  <script>

    var stageWidth = window.innerWidth;
    var stageHeight = window.innerHeight;

    var stage = new Konva.Stage({
        container: 'container',
        width: stageWidth,
        height: stageHeight,
        draggable: true,
        listening: true
    });

    function writeMessage(message) {
        text.setText(message);
        layer.draw();
    }


    var layer = new Konva.Layer();
    stage.add(layer);

    stage.on('dblclick', onDoubleClick);


    function onDoubleClick () {
        var group = new Konva.Group({
            draggable: true,
            name: "stickyGroup"
        });
        layer.add(group);

        // add cursor styling
        group.on('mouseover', function() {
            document.body.style.cursor = 'pointer';
        });
        group.on('mouseout', function() {
            document.body.style.cursor = 'default';
        });

        // UNCOMMENT THIS BLOCK to try sticky 'lifting' and 'dropping' animation
        // TODO is buggy (only works on first sticky, doesn't raise text too,
        // animation not smooth)
        // ------------------------------------------------------
        // Sticky 'raises' when dragged
        // group.on('dragstart', function() {
        //     group.tweenGrab.play();
        // });

        // // Sticky comes back down when dropped
        // group.on('dragend', function() {
        //     group.tweenDrop.play();
        // });
        // ------------------------------------------------------


        // group.add( new Konva.Rect({
          var rect = new Konva.Rect({
            x: stage.getPointerPosition().x - 125,
            y: stage.getPointerPosition().y - 10,
            width: 250,
            height: 250,
            fill: Konva.Util.getRandomColor(),
            stroke: 'gray',
            strokeWidth: 2,
            shadowOffsetX: 5,
            shadowOffsetY: 5,
            shadowColor: 'black'
        });
        group.add(rect);

        var textNode = new Konva.Text({
            x: stage.getPointerPosition().x - 125,
            y: stage.getPointerPosition().y,
            text: 'Click to edit. \n Then press enter.',
            fontSize: 18,
            fontFamily: 'Calibri',
            fill: '#555',
            width: 250,
            padding: 20,
            align: 'center',
            listening: true
        });
        group.add(textNode);

        textNode.on('click', () => {
            var textPosition = textNode.getAbsolutePosition();
            var stageBox = stage.getContainer().getBoundingClientRect();


            var areaPosition = {
                x: textPosition.x + stageBox.left,
                y: textPosition.y + stageBox.top
            };

            // create textarea and style it
            var textarea = document.createElement('textarea');
            document.body.appendChild(textarea);

            textarea.value = textNode.text();
            textarea.style.position = 'absolute';
            textarea.style.top = areaPosition.y + 'px';
            textarea.style.left = areaPosition.x + 'px';
            textarea.style.width = textNode.width();

            textarea.focus();


            textarea.addEventListener('keydown', function (e) {
                // hide on enter
                if (e.keyCode === 13) {
                    textNode.text(textarea.value);
                    layer.draw();
                    document.body.removeChild(textarea);
                }
            });
            }
        );


        // Tween for drag and drop
        group.tweenGrab = new Konva.Tween({
          node: rect,
          shadowOffsetX: 15,
          shadowOffsetY: 15,
          duration: 0.5,
          scaleX: 1.1,
          scaleY: 1.1,
          easing: Konva.Easings.ElasticEaseOut,

        });

        group.tweenDrop = new Konva.Tween({
          node: rect,
          duration: 1,
          easing: Konva.Easings.ElasticEaseOut,
          scaleX: 1,
          scaleY: 1,
          shadowOffsetX: 5,
          shadowOffsetY: 5,
        });

        var tr = new Konva.Transformer({
          node: group,
          keepRatio: true,
          anchorSize: 10,
          borderStroke: 'gray',
          rotationSnaps: [0, 90, 180, 270],

        });
        layer.add(tr);
        layer.draw();

        stage.on('click tap', function (e) {
         // if click on empty area - remove all transformers
           if (e.target === stage) {
             stage.find('Transformer').destroy();
             layer.draw();
             return;
           }
           // do nothing if clicked NOT on our rectangles
           if (!e.target.parent.hasName("stickyGroup")) {
             return;
           }

           // remove old transformers
           // TODO: we can skip it if current rect is already selected
           stage.find('Transformer').destroy();

           // create new transformer
           var tr = new Konva.Transformer();
           tr.attachTo(e.target.parent);
           layer.add(tr);
           layer.draw();
         });
     }

    function fitStageIntoParentContainer() {
        var container = document.querySelector('#stage-parent');

        // now we need to fit stage into parent
        var containerWidth = container.offsetWidth;
        // to do this we need to scale the stage
        var scale = containerWidth / stageWidth;


        stage.width(stageWidth * scale);
        stage.height(stageHeight * scale);
        stage.scale({ x: scale, y: scale });
        stage.draw();
    }
    fitStageIntoParentContainer();
    window.addEventListener('resize', fitStageIntoParentContainer);


     // ZOOMING

    var scaleBy = 1.05;
    stage.on('wheel', e => {
        e.evt.preventDefault();
        var oldScale = stage.scaleX();

        var mousePointTo = {
          x: stage.getPointerPosition().x / oldScale - stage.x() / oldScale,
          y: stage.getPointerPosition().y / oldScale - stage.y() / oldScale
        };

        var newScale =
          e.evt.deltaY > 0 ? oldScale * scaleBy : oldScale / scaleBy;
        stage.scale({ x: newScale, y: newScale });

        var newPos = {
          x:
            -(mousePointTo.x - stage.getPointerPosition().x / newScale) *
            newScale,
          y:
            -(mousePointTo.y - stage.getPointerPosition().y / newScale) *
            newScale
        };
        stage.position(newPos);
        stage.batchDraw();
    });
  </script>


    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
